apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: so1s-logging-app-dev
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: so1s-project-dev

  source:
    repoURL: https://github.com/aws/eks-charts.git
    targetRevision: eacdfff43ec092cb8ab62738c4290b106d591c17
    path: stable/aws-for-fluent-bit

    helm:
      releaseName: logging
      values: |
        service:
          extraService: |
            Flush                     5
            Log_Level                 info
            Daemon                    off
            Parsers_File              parser_extra.conf
            HTTP_Server  On
            HTTP_Listen  0.0.0.0
            HTTP_PORT    2020
            storage.path              /var/fluent-bit/state/flb-storage/
            storage.sync              normal
            storage.checksum          off
            storage.backlog.mem_limit 5M
        
        extraParsers: |

          [PARSER]
              Name                docker
              Format              json
              Time_Key            time
              Time_Format         %Y-%m-%dT%H:%M:%S.%LZ

          [PARSER]
              Name                syslog
              Format              regex
              Regex               ^(?<time>[^ ]* {1,2}[^ ]* [^ ]*) (?<host>[^ ]*) (?<ident>[a-zA-Z0-9_\/\.\-]*)(?:\[(?<pid>[0-9]+)\])?(?:[^\:]*\:)? *(?<message>.*)$
              Time_Key            time
              Time_Format         %b %d %H:%M:%S
          
          [PARSER]
              Name                container_firstline
              Format              regex
              Regex               (?<log>(?<="log":")\S(?!\.).*?)(?<!\\)".*(?<stream>(?<="stream":").*?)".*(?<time>\d{4}-\d{1,2}-\d{1,2}T\d{2}:\d{2}:\d{2}\.\w*).*(?=})
              Time_Key            time
              Time_Format         %Y-%m-%dT%H:%M:%S.%LZ

          [PARSER]
            Name                cwagent_firstline
            Format              regex
            Regex               (?<log>(?<="log":")\d{4}[\/-]\d{1,2}[\/-]\d{1,2}[ T]\d{2}:\d{2}:\d{2}(?!\.).*?)(?<!\\)".*(?<stream>(?<="stream":").*?)".*(?<time>\d{4}-\d{1,2}-\d{1,2}T\d{2}:\d{2}:\d{2}\.\w*).*(?=})
            Time_Key            time
            Time_Format         %Y-%m-%dT%H:%M:%S.%LZ
        
        input:
          tag: "application.*"
          path: "/var/log/containers/fluent-bit*"
          db: "/var/fluent-bit/state/flb_log.db"
          parser: "docker"
          dockerMode: "ON"
          memBufLimit: 5
          skipLongLines: "On"
          refreshInterval: 10

        additionalInputs: |

            [INPUT]
                Name                tail
                Tag                 application.*
                Exclude_Path        /var/log/containers/cloudwatch-agent*, /var/log/containers/fluent-bit*, /var/log/containers/aws-node*, /var/log/containers/kube-proxy*
                Path                /var/log/containers/*.log
                Docker_Mode         On
                Docker_Mode_Flush   5
                Docker_Mode_Parser  container_firstline
                Parser              docker
                DB                  /var/fluent-bit/state/flb_container.db
                Mem_Buf_Limit       50MB
                Skip_Long_Lines     On
                Refresh_Interval    10
                Rotate_Wait         30
                storage.type        filesystem
                Read_from_Head      ${READ_FROM_HEAD}

            [INPUT]
                Name                tail
                Tag                 application.*
                Path                /var/log/containers/cloudwatch-agent*
                Docker_Mode         On
                Docker_Mode_Flush   5
                Docker_Mode_Parser  cwagent_firstline
                Parser              docker
                DB                  /var/fluent-bit/state/flb_cwagent.db
                Mem_Buf_Limit       5MB
                Skip_Long_Lines     On
                Refresh_Interval    10
                Read_from_Head      ${READ_FROM_HEAD}
          
        filter:
          match: application.*
          kubeURL: https://kubernetes.default.svc:443
          mergeLog: On
          mergeLogKey: log_processed
          keepLog: Off
          k8sLoggingParser: On
          k8sLoggingExclude: Off
          bufferSize: 0
          extraFilters: |
            Kube_Tag_Prefix     application.var.log.containers.
            Labels              Off
            Annotations         Off
            Use_Kubelet         On
            Kubelet_Port        10250


        cloudWatch:
          match: "application.*"
          region: "ap-northeast-2"
          logGroupName: "/aws/eks/fluentbit-cloudwatch/logs"
          logStreamPrefix: "${HOST_NAME}-"
          roleArn: arn:aws:iam::089143290485:role/grafana-cloudwatch
        

        serviceMonitor:
          enabled: true
          namespace: logging
          interval: 30s
          telemetryPath: /api/v1/metrics/prometheus
          service:
            type: ClusterIP
            port: 2020
            targetPort: 2020
        

        tolerations:
          - key: node-role.kubernetes.io/master
            operator: Exists
            effect: NoSchedule
          - operator: "Exists"
            effect: "NoExecute"
          - operator: "Exists"
            effect: "NoSchedule"


        firehose:
          enabled: false

        kinesis:
          enabled: false

        elasticsearch:
          enabled: false


  destination:
    server: https://kubernetes.default.svc
    namespace: logging

  syncPolicy:
    automated: 
      prune: true 
      selfHeal: true   
    syncOptions:
      - CreateNamespace=true
